{% extends "base.html" %}

{% block title %}Admin Dashboard (Read-Only){% endblock %}

{% block content %}
<header class="py-4 bg-dark text-white border-bottom shadow-sm">
    <div class="container">
        <h1 class="fw-bold"><i class="bi bi-gear-fill me-2"></i> Simple Admin Dashboard</h1>
        <p class="lead text-muted">Read-only overview of core application data for monitoring and quick navigation to editing.</p>
        <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-light mt-2">Log Out</a>
    </div>
</header>

<section class="py-5">
    <div class="container">

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <h2 class="mb-3 mt-4 text-primary">üë• User Management ({{ users | length }} Total)</h2>
        <div class="table-responsive mb-5 shadow-sm bg-white rounded">
            <table class="table table-hover table-sm">
                <thead class="table-primary">
                    <tr>
                        <th>ID</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Balance</th>
                        <th>Is Admin?</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr id="user-row-{{ user.id }}">
                        <td>{{ user.id }}</td>
                        <td>{{ user.fullname }}</td>
                        <td>{{ user.email }}</td>
                        <td><span class="badge
                            {% if user.status == 'Admin' %}bg-danger
                            {% elif user.status == 'Lawyer' %}bg-success
                            {% else %}bg-secondary{% endif %}">
                            {{ user.status }}
                        </span></td>
                        <td><span class="text-success fw-bold">${{ user.balance | round(2) | default('0.00', true) }}</span></td>
                        <td>{% if user.isAdmin %}<span class="badge bg-danger">Yes</span>{% else %}No{% endif %}</td>
                        <td>
                            <!-- –ö–Ω–æ–ø–∫–∞ "Change Details" –≤–µ–¥–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–æ—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                            <a href="{{ url_for('edit_profile', user_id=user.id) }}" class="btn btn-sm btn-outline-primary">Change Details</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 class="mb-3 mt-4 text-primary">üìÖ Consultation Records ({{ consultations | length }} Total)</h2>
        <div class="table-responsive shadow-sm bg-white rounded">
            <table class="table table-hover table-sm" id="consultations-table">
                <thead class="table-primary">
                    <tr>
                        <th>ID</th>
                        <th>Date & Time</th>
                        <th>Client</th>
                        <th>Lawyer</th>
                        <th>Price ($)</th>
                        <th>Status</th>
                        <th>Payment</th>
                        <th>Actions</th> <!-- –ù–û–í–´–ô –°–¢–û–õ–ë–ï–¶ -->
                    </tr>
                </thead>
                <tbody>
                    {% for c in consultations %}
                    <tr id="consultation-row-{{ c.id }}">
                        <td>{{ c.id }}</td>
                        <td>{{ c.date.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ c.client.fullname if c.client else 'N/A' }}</td>
                        <td>{{ c.lawyer.fullname if c.lawyer else 'N/A' }}</td>
                        <td><span class="text-info">${{ c.price | round(2) | default('0.00', true) }}</span></td>
                        <td data-status-cell="{{ c.id }}"><span class="badge
                            {% if c.status == 'completed' %}bg-success
                            {% elif c.status == 'pending' %}bg-warning
                            {% elif c.status == 'cancelled' %}bg-secondary
                            {% else %}bg-danger{% endif %}">
                            {{ c.status }}
                        </span></td>
                        <td data-payment-cell="{{ c.id }}"><span class="badge
                            {% if c.payment_status == 'paid' %}bg-success
                            {% elif c.payment_status == 'refunded' %}bg-info
                            {% else %}bg-warning{% endif %}">
                            {{ c.payment_status }}
                        </span></td>
                        <td>
                            <!-- –ö–ù–û–ü–ö–ê –û–¢–ú–ï–ù–´ -->
                            {% if c.status != 'cancelled' %}
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelConsultation({{ c.id }})">Cancel</button>
                            {% else %}
                            <button class="btn btn-sm btn-secondary" disabled>Cancelled</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- JavaScript –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ DELETE –∑–∞–ø—Ä–æ—Å–∞ -->
<script>
    function cancelConsultation(consultationId) {
        // –ó–∞–º–µ–Ω–∞ alert() –Ω–∞ window.confirm() –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        if (!window.confirm("Are you sure you want to cancel Consultation #" + consultationId + "? This will process a refund if paid.")) {
            return; // –û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è
        }

        const url = `/api/consultations/${consultationId}`;

        fetch(url, {
            method: 'DELETE',
            // –í–Ω–∏–º–∞–Ω–∏–µ: –µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ CSRF –∑–∞—â–∏—Ç—É, –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω.
        })
        .then(response => response.json())
        .then(data => {
            if (data.message.includes('successfully cancelled')) {
                // –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–º–µ–Ω–∞: –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ —Ü–≤–µ—Ç —è—á–µ–µ–∫
                const statusCell = document.querySelector(`[data-status-cell="${consultationId}"]`);
                const paymentCell = document.querySelector(`[data-payment-cell="${consultationId}"]`);
                const row = document.getElementById(`consultation-row-${consultationId}`);

                if (statusCell) {
                    statusCell.innerHTML = '<span class="badge bg-secondary">cancelled</span>';
                }
                if (paymentCell && data.refund_details.is_refunded) {
                    paymentCell.innerHTML = '<span class="badge bg-info">refunded</span>';
                }

                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                const button = row.querySelector('button');
                if(button) {
                    button.disabled = true;
                    button.textContent = 'Cancelled';
                    button.classList.remove('btn-outline-danger');
                    button.classList.add('btn-secondary');
                }

                // –í—ã–≤–æ–¥–∏–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                alert(`Cancellation successful. Refund amount: $${data.refund_details.amount}.`);

            } else {
                // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ—Ç API
                alert('Cancellation Failed: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('An error occurred while connecting to the server.');
        });
    }
</script>

{% endblock %}